# Custom ModSecurity Rules for WordPress Protection

# Initialize collection for rate limiting
SecAction "id:200000,phase:1,nolog,pass,initcol:ip=%{REMOTE_ADDR},expirevar:ip.wp_login_attempt=300,expirevar:ip.xmlrpc_attempt=300"

# Rate limit wp-login.php
SecRule REQUEST_URI "@rx /wp-login\.php" \
    "id:200001,phase:2,deny,status:403,log,msg:'Rate limit exceeded for wp-login.php',chain"
    SecRule REQUEST_METHOD "POST" "chain"
    SecRule IP:wp_login_attempt "@gt 10"
SecRule REQUEST_URI "@rx /wp-login\.php" "id:200002,phase:2,pass,nolog,chain"
    SecRule REQUEST_METHOD "POST" "setvar:ip.wp_login_attempt=+1"

# Rate limit xmlrpc.php (not blocked outright)
SecRule REQUEST_URI "@rx /xmlrpc\.php" \
    "id:200003,phase:2,deny,status:403,log,msg:'Rate limit exceeded for xmlrpc.php',chain"
    SecRule IP:xmlrpc_attempt "@gt 20"
SecRule REQUEST_URI "@rx /xmlrpc\.php" "id:200004,phase:2,pass,nolog,setvar:ip.xmlrpc_attempt=+1"

# Block known bad user agents
SecRule REQUEST_HEADERS:User-Agent "@rx (masscan|sqlmap|nikto|fimap|nmap|nessus|libwww-perl|acunetix|curl|wget|python-requests|httpclient)" \
    "id:200005,phase:1,deny,status:403,log,msg:'Blocked known bad user agent'"

# Block access to sensitive files
SecRule REQUEST_URI "@rx \.env$" \
    "id:200006,phase:2,deny,status:403,log,msg:'Blocked access to .env file'"
SecRule REQUEST_URI "@rx (\.git|\.svn|\.htaccess|\.htpasswd|web\.config)" \
    "id:200007,phase:2,deny,status:403,log,msg:'Blocked access to sensitive file'"

# Restrict HTTP methods
SecRule REQUEST_METHOD "!^(GET|POST|HEAD)$" \
    "id:200008,phase:1,deny,status:405,log,msg:'Blocked uncommon HTTP method: %{REQUEST_METHOD}'"
